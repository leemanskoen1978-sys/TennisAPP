<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Lesson Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --court-green: #1a4d2e;
            --bright-green: #4caf50;
            --tennis-yellow: #ffeb3b;
            --line-white: #f8f9fa;
            --clay-orange: #ff6f3c;
            --dark-bg: #0f1419;
            --card-bg: #1a2332;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--dark-bg);
            color: var(--line-white);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(76, 175, 80, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 235, 59, 0.08) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--court-green) 0%, #2d5f3f 100%);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        header::before {
            content: 'üéæ';
            position: absolute;
            font-size: 200px;
            opacity: 0.1;
            right: -50px;
            top: -50px;
            transform: rotate(-15deg);
        }

        h1 {
            font-family: 'Righteous', cursive;
            font-size: 3.5rem;
            letter-spacing: 2px;
            color: var(--tennis-yellow);
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }

        .quick-add {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 2px solid rgba(76, 175, 80, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .quick-add h3 {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            color: var(--tennis-yellow);
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--bright-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--bright-green);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        option {
            background: var(--card-bg);
            color: white;
        }

        .btn {
            background: linear-gradient(135deg, var(--clay-orange) 0%, #ff8c61 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 111, 60, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 111, 60, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-add {
            width: 100%;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--bright-green), var(--tennis-yellow));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.3);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--tennis-yellow);
            font-family: 'Righteous', cursive;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            font-family: 'Righteous', cursive;
            font-size: 2rem;
            letter-spacing: 1px;
            margin-bottom: 25px;
            color: var(--tennis-yellow);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .lesson-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--clay-orange);
            transition: all 0.3s ease;
            position: relative;
        }

        .lesson-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .lesson-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--tennis-yellow);
        }

        .lesson-date {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .lesson-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .btn-icon:hover {
            background: var(--clay-orange);
            transform: scale(1.1);
        }

        .lesson-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .detail-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-row label {
            font-size: 0.75rem;
        }

        .payment-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-qr { background: linear-gradient(135deg, #9c27b0, #ba68c8); }
        .payment-sponsor { background: linear-gradient(135deg, #2196f3, #64b5f6); }
        .payment-cash { background: linear-gradient(135deg, #4caf50, #81c784); }
        .payment-invoice { background: linear-gradient(135deg, #ff9800, #ffb74d); }
        .payment-beurtenkaart { background: linear-gradient(135deg, #f44336, #e57373); }
        .payment-unpaid { background: linear-gradient(135deg, #757575, #9e9e9e); }

        .beurtenkaart-section {
            background: rgba(244, 67, 54, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid rgba(244, 67, 54, 0.3);
            grid-column: 1 / -1;
        }

        .beurtenkaart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .client-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--bright-green);
            transition: all 0.3s ease;
        }

        .client-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .client-name {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--tennis-yellow);
        }

        .client-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .stat {
            opacity: 0.8;
        }

        .stat strong {
            color: var(--bright-green);
        }

        .beurtenkaart-info {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .export-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .export-controls {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .export-preview {
            background: rgba(0, 0, 0, 0.4);
            padding: 25px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            opacity: 0.5;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bright-green);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--tennis-yellow);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 2px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            font-family: 'Righteous', cursive;
            font-size: 1.8rem;
            color: var(--tennis-yellow);
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #e57373);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-item {
            animation: fadeIn 0.3s ease;
        }

        .beurtenkaart-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--clay-orange);
            transition: all 0.3s ease;
        }

        .beurtenkaart-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .beurtenkaart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .beurtenkaart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--tennis-yellow);
        }

        .beurtenkaart-status {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-active {
            background: linear-gradient(135deg, #4caf50, #81c784);
        }

        .status-full {
            background: linear-gradient(135deg, #f44336, #e57373);
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.3);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--bright-green), var(--tennis-yellow));
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .progress-fill.full {
            background: linear-gradient(90deg, var(--clay-orange), #ff8c61);
        }

        .beurtenkaart-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .beurtenkaart-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéæ Tennis Lesson Tracker</h1>
            <p class="subtitle">Beheer je tennislessen, betalingen & beurtenkaarten</p>
        </header>

        <div class="quick-add">
            <h3>‚ûï Nieuwe Les Toevoegen</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Datum</label>
                    <input type="date" id="lessonDate" required>
                </div>
                <div class="form-group">
                    <label>Tijd</label>
                    <input type="time" id="lessonTime" required>
                </div>
                <div class="form-group">
                    <label>Client Naam</label>
                    <input type="text" id="clientName" placeholder="Naam van de client" required>
                </div>
                <div class="form-group">
                    <label>Les Omschrijving</label>
                    <input type="text" id="lessonDescription" placeholder="Bijv. Tennis Les, Priv√©les, etc.">
                </div>
            </div>
            <button class="btn btn-add" onclick="addLesson()">Les Toevoegen</button>
            
            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
                <h3 style="font-family: 'Righteous', cursive; font-size: 1.5rem; color: var(--tennis-yellow); margin-bottom: 15px;">üì• Importeer van Google Calendar</h3>
                <p style="opacity: 0.8; margin-bottom: 15px; font-size: 0.95rem;">
                    Download je calendar als .ics bestand en importeer je lessen automatisch!
                </p>
                <input type="file" id="icsFileInput" accept=".ics" style="display: none;" onchange="handleIcsUpload(event)">
                <button class="btn" onclick="document.getElementById('icsFileInput').click()">
                    üìÖ Selecteer .ics Bestand
                </button>
                <div id="importStatus" style="margin-top: 15px;"></div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalLessons">0</div>
                <div class="stat-label">Totaal Lessen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="paidLessons">0</div>
                <div class="stat-label">Betaald</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="unpaidLessons">0</div>
                <div class="stat-label">Onbetaald</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalClients">0</div>
                <div class="stat-label">Clients</div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üìÖ Lessen</h2>
                <div class="lesson-list" id="lessonList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üéæ</div>
                        <p>Nog geen lessen. Voeg je eerste les toe!</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üë• Clients & Beurtenkaarten</h2>
                <div class="lesson-list" id="clientOverview">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Client overzicht verschijnt hier</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h2>üé´ Beurtenkaart Beheer</h2>
            <p style="opacity: 0.8; margin-bottom: 20px;">Beheer alle 10-beurtenkaarten per client. Koppel ze aan lessen om automatisch bij te houden hoeveel beurten er gebruikt zijn.</p>
            
            <div style="background: rgba(255, 255, 255, 0.03); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="font-size: 1.2rem; color: var(--tennis-yellow); margin-bottom: 15px;">‚ûï Nieuwe Beurtenkaart</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Client Naam</label>
                        <input type="text" id="cardClientName" placeholder="Naam van de client" list="clientList">
                        <datalist id="clientList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Kaartnummer</label>
                        <input type="text" id="cardNumber" placeholder="Bijv. KAART-001 of 1">
                    </div>
                    <div class="form-group">
                        <label>Aankoopdatum</label>
                        <input type="date" id="cardPurchaseDate">
                    </div>
                    <div class="form-group">
                        <label>Notities (optioneel)</label>
                        <input type="text" id="cardNotes" placeholder="Bijv. Betaald per Payconiq">
                    </div>
                </div>
                <button class="btn btn-add" onclick="addBeurtenkaart()">Beurtenkaart Toevoegen</button>
            </div>

            <div id="beurtenkaartList"></div>
        </div>

        <div class="export-section">
            <h2 style="font-family: 'Righteous', cursive; font-size: 2rem; margin-bottom: 25px; color: var(--tennis-yellow);">üìä Export voor Facturen</h2>
            <div class="export-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>Selecteer Maand</label>
                    <input type="month" id="exportMonth" />
                </div>
                <button class="btn" onclick="generateExport()">Genereer Export</button>
                <button class="btn btn-secondary" onclick="downloadCSV()">Download CSV</button>
            </div>
            <div class="export-preview" id="exportPreview">
                Selecteer een maand en klik op "Genereer Export" om de data te zien
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Les Verwijderen?</h3>
            <p>Weet je zeker dat je deze les wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" style="flex: 1" onclick="closeDeleteModal()">Annuleren</button>
                <button class="btn btn-danger" style="flex: 1" onclick="confirmDelete()">Verwijderen</button>
            </div>
        </div>
    </div>

    <!-- Bulk Payment Modal -->
    <div class="modal" id="bulkPaymentModal">
        <div class="modal-content">
            <h3>üí≥ Bulk Betaling</h3>
            <p>Stel de betaalstatus in voor alle onbetaalde lessen van <strong id="bulkClientName"></strong></p>
            <p style="opacity: 0.7; margin-top: 10px;">Aantal onbetaalde lessen: <strong id="bulkLessonCount"></strong></p>
            
            <div style="margin-top: 25px;">
                <div class="form-group">
                    <label>Betaalmethode</label>
                    <select id="bulkPaymentMethod" onchange="handleBulkPaymentMethodChange()">
                        <option value="qr">QR Code</option>
                        <option value="sponsor">Sponsor</option>
                        <option value="cash">Cash</option>
                        <option value="invoice">Factuur</option>
                        <option value="beurtenkaart">10 Beurtenkaart</option>
                    </select>
                </div>
                
                <div id="bulkBeurtenkaartSection" style="display: none; margin-top: 15px;">
                    <div class="form-group">
                        <label>Beurtenkaart Nummer</label>
                        <input type="text" id="bulkBeurtenkaartNumber" placeholder="Bijv. KAART-001">
                    </div>
                    <p style="opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                        ‚ÑπÔ∏è De lessen worden automatisch genummerd (1, 2, 3, etc.)
                    </p>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" style="flex: 1" onclick="closeBulkPaymentModal()">Annuleren</button>
                <button class="btn btn-success" style="flex: 1" onclick="applyBulkPayment()">Toepassen</button>
            </div>
        </div>
    </div>

    <script>
        let lessons = [];
        let clients = new Map();
        let beurtenkaarten = [];
        let deleteId = null;

        // Initialize storage
        async function initStorage() {
            try {
                const storedLessons = await window.storage.get('tennis-lessons-standalone');
                if (storedLessons && storedLessons.value) {
                    lessons = JSON.parse(storedLessons.value);
                }

                const storedCards = await window.storage.get('tennis-beurtenkaarten');
                if (storedCards && storedCards.value) {
                    beurtenkaarten = JSON.parse(storedCards.value);
                }

                updateUI();
            } catch (error) {
                console.log('No stored data found, starting fresh');
            }

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lessonDate').value = today;
            document.getElementById('lessonTime').value = '10:00';
            document.getElementById('cardPurchaseDate').value = today;
        }

        async function saveToStorage() {
            try {
                await window.storage.set('tennis-lessons-standalone', JSON.stringify(lessons));
                await window.storage.set('tennis-beurtenkaarten', JSON.stringify(beurtenkaarten));
            } catch (error) {
                console.error('Error saving to storage:', error);
            }
        }

        function addBeurtenkaart() {
            const clientName = document.getElementById('cardClientName').value.trim();
            const cardNumber = document.getElementById('cardNumber').value.trim();
            const purchaseDate = document.getElementById('cardPurchaseDate').value;
            const notes = document.getElementById('cardNotes').value.trim();

            if (!clientName || !cardNumber) {
                alert('Vul minimaal de client naam en kaartnummer in!');
                return;
            }

            // Check if card already exists
            const existing = beurtenkaarten.find(c => 
                c.clientName === clientName && c.cardNumber === cardNumber
            );

            if (existing) {
                alert('Deze beurtenkaart bestaat al voor deze client!');
                return;
            }

            const card = {
                id: Date.now().toString(),
                clientName: clientName,
                cardNumber: cardNumber,
                purchaseDate: purchaseDate || new Date().toISOString().split('T')[0],
                notes: notes,
                createdAt: new Date().toISOString()
            };

            beurtenkaarten.push(card);
            saveToStorage();
            updateUI();

            // Reset form
            document.getElementById('cardClientName').value = '';
            document.getElementById('cardNumber').value = '';
            document.getElementById('cardNotes').value = '';

            // Scroll to beurtenkaart list
            document.getElementById('beurtenkaartList').scrollIntoView({ behavior: 'smooth' });
        }

        function deleteBeurtenkaart(cardId) {
            if (!confirm('Weet je zeker dat je deze beurtenkaart wilt verwijderen? Dit verwijdert NIET de lessen die ermee gekoppeld zijn.')) {
                return;
            }

            beurtenkaarten = beurtenkaarten.filter(c => c.id !== cardId);
            saveToStorage();
            updateUI();
        }

        function getBeurtenUsedForCard(clientName, cardNumber) {
            return lessons.filter(l => 
                l.clientName === clientName && 
                l.paymentStatus === 'beurtenkaart' && 
                l.beurtenkaartNumber === cardNumber
            ).length;
        }

        function addLesson() {
            const date = document.getElementById('lessonDate').value;
            const time = document.getElementById('lessonTime').value;
            const clientName = document.getElementById('clientName').value.trim();
            const description = document.getElementById('lessonDescription').value.trim() || 'Tennis Les';

            if (!date || !time || !clientName) {
                alert('Vul alle verplichte velden in!');
                return;
            }

            const datetime = new Date(`${date}T${time}`);
            const lesson = {
                id: Date.now().toString(),
                summary: description,
                start: datetime.toISOString(),
                clientName: clientName,
                paymentStatus: 'unpaid',
                beurtenkaartNumber: null,
                beurtenUsed: 0
            };

            lessons.push(lesson);
            lessons.sort((a, b) => new Date(a.start) - new Date(b.start));

            saveToStorage();
            updateUI();

            // Reset form
            document.getElementById('clientName').value = '';
            document.getElementById('lessonDescription').value = '';
            
            // Scroll to lessons
            document.getElementById('lessonList').scrollIntoView({ behavior: 'smooth' });
        }

        async function handleIcsUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<div style="color: var(--tennis-yellow); padding: 10px; background: rgba(255, 235, 59, 0.1); border-radius: 8px;">‚è≥ Bezig met importeren...</div>';

            try {
                const text = await file.text();
                const importedLessons = parseIcsFile(text);

                if (importedLessons.length === 0) {
                    statusDiv.innerHTML = '<div style="color: var(--clay-orange); padding: 10px; background: rgba(255, 111, 60, 0.1); border-radius: 8px;">‚ùå Geen events gevonden in het .ics bestand</div>';
                    return;
                }

                // Filter for events in the next 4 months starting from current month
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endDate = new Date(now.getFullYear(), now.getMonth() + 4, 0, 23, 59, 59);

                const filteredEvents = importedLessons.filter(event => {
                    const eventDate = new Date(event.start);
                    return eventDate >= startOfMonth && eventDate <= endDate;
                });

                // Create a map of imported lessons by their UID
                const importedMap = new Map();
                filteredEvents.forEach(lesson => {
                    importedMap.set(lesson.icsUid, lesson);
                });

                // Track statistics
                let newCount = 0;
                let updatedCount = 0;
                let deletedCount = 0;

                // Mark lessons that came from ICS import
                const lessonsFromIcs = lessons.filter(l => l.icsUid);
                
                // Delete lessons that are no longer in the ICS file
                const lessonsToKeep = lessons.filter(lesson => {
                    if (!lesson.icsUid) {
                        // Keep manually added lessons
                        return true;
                    }
                    
                    const stillExists = importedMap.has(lesson.icsUid);
                    if (!stillExists) {
                        deletedCount++;
                    }
                    return stillExists;
                });

                lessons = lessonsToKeep;

                // Update existing and add new lessons
                filteredEvents.forEach(importedLesson => {
                    const existing = lessons.find(l => l.icsUid === importedLesson.icsUid);

                    if (existing) {
                        // Update existing lesson but PRESERVE payment data
                        existing.summary = importedLesson.summary;
                        existing.start = importedLesson.start;
                        existing.clientName = importedLesson.clientName;
                        // Keep: paymentStatus, beurtenkaartNumber, beurtenUsed
                        updatedCount++;
                    } else {
                        // Add new lesson
                        lessons.push({
                            ...importedLesson,
                            paymentStatus: 'unpaid',
                            beurtenkaartNumber: null,
                            beurtenUsed: 0
                        });
                        newCount++;
                    }
                });

                lessons.sort((a, b) => new Date(a.start) - new Date(b.start));
                await saveToStorage();
                updateUI();

                statusDiv.innerHTML = `
                    <div style="color: var(--bright-green); padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border: 1px solid rgba(76, 175, 80, 0.3);">
                        ‚úÖ Import succesvol!<br>
                        <strong>${newCount}</strong> nieuwe lessen toegevoegd<br>
                        <strong>${updatedCount}</strong> bestaande lessen bijgewerkt<br>
                        ${deletedCount > 0 ? `<strong>${deletedCount}</strong> verwijderde lessen gesynchroniseerd<br>` : ''}
                        <span style="opacity: 0.7; font-size: 0.9rem;">Periode: ${startOfMonth.toLocaleDateString('nl-BE')} - ${endDate.toLocaleDateString('nl-BE')}</span>
                    </div>
                `;

                // Scroll to lessons
                setTimeout(() => {
                    document.getElementById('lessonList').scrollIntoView({ behavior: 'smooth' });
                }, 500);

            } catch (error) {
                console.error('ICS import error:', error);
                statusDiv.innerHTML = `<div style="color: var(--clay-orange); padding: 10px; background: rgba(255, 111, 60, 0.1); border-radius: 8px;">‚ùå Fout bij importeren: ${error.message}</div>`;
            }

            // Reset file input
            event.target.value = '';
        }

        function parseIcsFile(icsContent) {
            const lessons = [];
            const lines = icsContent.split(/\r?\n/);
            let currentEvent = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        icsUid: '',
                        summary: '',
                        start: '',
                        clientName: ''
                    };
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.start && currentEvent.summary && currentEvent.icsUid) {
                        // Extract client name from summary
                        currentEvent.clientName = extractClientNameFromSummary(currentEvent.summary);
                        lessons.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    // Parse SUMMARY
                    if (line.startsWith('SUMMARY:')) {
                        currentEvent.summary = line.substring(8).trim();
                    }
                    // Parse DTSTART (supports both DATE and DATETIME formats)
                    else if (line.startsWith('DTSTART')) {
                        const dateMatch = line.match(/DTSTART[^:]*:(\d{8}T?\d{6}Z?|\d{8})/);
                        if (dateMatch) {
                            currentEvent.start = parseIcsDate(dateMatch[1]);
                        }
                    }
                    // Handle UID for unique identification
                    else if (line.startsWith('UID:')) {
                        const uid = line.substring(4).trim();
                        currentEvent.icsUid = uid;
                        currentEvent.id = uid;
                    }
                }
            }

            return lessons;
        }

        function parseIcsDate(dateString) {
            // Remove timezone indicator
            dateString = dateString.replace('Z', '');

            // Format: YYYYMMDDTHHMMSS or YYYYMMDD
            const year = dateString.substring(0, 4);
            const month = dateString.substring(4, 6);
            const day = dateString.substring(6, 8);

            if (dateString.length === 8) {
                // Date only (no time)
                return new Date(`${year}-${month}-${day}T10:00:00`).toISOString();
            } else {
                // Date and time
                const hour = dateString.substring(9, 11);
                const minute = dateString.substring(11, 13);
                const second = dateString.substring(13, 15);
                return new Date(`${year}-${month}-${day}T${hour}:${minute}:${second}`).toISOString();
            }
        }

        function extractClientNameFromSummary(summary) {
            // Try to extract client name from summary
            // Common formats: "Tennis Lesson - John Doe", "John Doe - Tennis", "Tennis: John Doe"
            
            // Remove common tennis-related words
            let name = summary
                .replace(/tennis/gi, '')
                .replace(/lesson/gi, '')
                .replace(/les/gi, '')
                .replace(/priv√©/gi, '')
                .replace(/training/gi, '')
                .trim();

            // Split on common separators and take the longest part
            const parts = name.split(/[-:,]/);
            if (parts.length > 1) {
                // Take the longest non-empty part
                name = parts
                    .map(p => p.trim())
                    .filter(p => p.length > 0)
                    .sort((a, b) => b.length - a.length)[0];
            }

            // If we still have something meaningful, return it, otherwise use the original summary
            return name.length > 0 && name.length < 50 ? name : summary;
        }

        function updatePaymentStatus(lessonId, status) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.paymentStatus = status;
                if (status !== 'beurtenkaart') {
                    lesson.beurtenkaartNumber = null;
                    lesson.beurtenUsed = 0;
                }
                saveToStorage();
                updateUI();
            }
        }

        function updateBeurtenkaart(lessonId, number) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.beurtenkaartNumber = number;
                saveToStorage();
                updateUI();
            }
        }

        function updateBeurtenUsed(lessonId, used) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.beurtenUsed = parseInt(used) || 0;
                saveToStorage();
                updateUI();
            }
        }

        function updateClientName(lessonId, name) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.clientName = name;
                saveToStorage();
                updateUI();
            }
        }

        function deleteLesson(lessonId) {
            deleteId = lessonId;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteId = null;
        }

        function confirmDelete() {
            if (deleteId) {
                lessons = lessons.filter(l => l.id !== deleteId);
                saveToStorage();
                updateUI();
                closeDeleteModal();
            }
        }

        function updateUI() {
            updateLessonList();
            updateClientOverview();
            updateStats();
            updateBeurtenkaartList();
            updateClientAutocomplete();
            setDefaultExportMonth();
        }

        function updateClientAutocomplete() {
            // Update the datalist for client autocomplete
            const uniqueClients = [...new Set([
                ...lessons.map(l => l.clientName),
                ...beurtenkaarten.map(c => c.clientName)
            ])].sort();

            const datalist = document.getElementById('clientList');
            datalist.innerHTML = uniqueClients.map(name => `<option value="${name}">`).join('');
        }

        function updateBeurtenkaartList() {
            const listDiv = document.getElementById('beurtenkaartList');

            if (beurtenkaarten.length === 0) {
                listDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé´</div><p>Nog geen beurtenkaarten toegevoegd</p></div>';
                return;
            }

            // Group by client
            const byClient = {};
            beurtenkaarten.forEach(card => {
                if (!byClient[card.clientName]) {
                    byClient[card.clientName] = [];
                }
                byClient[card.clientName].push(card);
            });

            listDiv.innerHTML = Object.entries(byClient).map(([clientName, cards]) => {
                const cardsHtml = cards.map(card => {
                    const used = getBeurtenUsedForCard(clientName, card.cardNumber);
                    const remaining = 10 - used;
                    const percentage = (used / 10) * 100;
                    const isFull = used >= 10;
                    const statusClass = isFull ? 'status-full' : 'status-active';
                    const statusText = isFull ? 'VOL' : `${remaining} OVER`;

                    const purchaseDate = new Date(card.purchaseDate).toLocaleDateString('nl-BE');

                    return `
                        <div class="beurtenkaart-card">
                            <div class="beurtenkaart-header">
                                <div class="beurtenkaart-title">Kaart #${card.cardNumber}</div>
                                <span class="beurtenkaart-status ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="progress-bar">
                                <div class="progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%">
                                    ${used}/10 beurten gebruikt
                                </div>
                            </div>

                            <div class="beurtenkaart-details">
                                <div>üìÖ Aangekocht: ${purchaseDate}</div>
                                ${card.notes ? `<div>üìù ${card.notes}</div>` : ''}
                            </div>

                            <div class="beurtenkaart-actions">
                                <button class="btn-icon" onclick="deleteBeurtenkaart('${card.id}')" title="Verwijder beurtenkaart">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: var(--tennis-yellow); font-size: 1.3rem; margin-bottom: 15px; font-family: 'Righteous', cursive;">
                            üë§ ${clientName}
                        </h3>
                        ${cardsHtml}
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            document.getElementById('totalLessons').textContent = lessons.length;
            document.getElementById('paidLessons').textContent = lessons.filter(l => l.paymentStatus !== 'unpaid').length;
            document.getElementById('unpaidLessons').textContent = lessons.filter(l => l.paymentStatus === 'unpaid').length;
            
            const uniqueClients = new Set(lessons.map(l => l.clientName));
            document.getElementById('totalClients').textContent = uniqueClients.size;
        }

        function updateLessonList() {
            const lessonList = document.getElementById('lessonList');
            
            if (lessons.length === 0) {
                lessonList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéæ</div><p>Nog geen lessen. Voeg je eerste les toe!</p></div>';
                return;
            }

            lessonList.innerHTML = lessons.map(lesson => {
                const date = new Date(lesson.start);
                const dateStr = date.toLocaleDateString('nl-BE', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('nl-BE', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const paymentClass = `payment-${lesson.paymentStatus}`;
                
                return `
                    <div class="lesson-item">
                        <div class="lesson-header">
                            <div style="flex: 1">
                                <div class="lesson-title">${lesson.summary}</div>
                                <div class="lesson-date">${dateStr} om ${timeStr}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="payment-badge ${paymentClass}">${lesson.paymentStatus}</span>
                                <div class="lesson-actions">
                                    <button class="btn-icon" onclick="deleteLesson('${lesson.id}')" title="Verwijder les">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                        <div class="lesson-details">
                            <div class="detail-row">
                                <label>Client</label>
                                <input type="text" value="${lesson.clientName}" 
                                       onchange="updateClientName('${lesson.id}', this.value)"
                                       placeholder="Client naam">
                            </div>
                            <div class="detail-row">
                                <label>Betaling</label>
                                <select onchange="updatePaymentStatus('${lesson.id}', this.value)">
                                    <option value="unpaid" ${lesson.paymentStatus === 'unpaid' ? 'selected' : ''}>Onbetaald</option>
                                    <option value="qr" ${lesson.paymentStatus === 'qr' ? 'selected' : ''}>QR Code</option>
                                    <option value="sponsor" ${lesson.paymentStatus === 'sponsor' ? 'selected' : ''}>Sponsor</option>
                                    <option value="cash" ${lesson.paymentStatus === 'cash' ? 'selected' : ''}>Cash</option>
                                    <option value="invoice" ${lesson.paymentStatus === 'invoice' ? 'selected' : ''}>Factuur</option>
                                    <option value="beurtenkaart" ${lesson.paymentStatus === 'beurtenkaart' ? 'selected' : ''}>10 Beurtenkaart</option>
                                </select>
                            </div>
                            ${lesson.paymentStatus === 'beurtenkaart' ? `
                                <div class="beurtenkaart-section">
                                    <div class="beurtenkaart-grid">
                                        <div class="detail-row">
                                            <label>Beurtenkaart #</label>
                                            <input type="text" value="${lesson.beurtenkaartNumber || ''}" 
                                                   onchange="updateBeurtenkaart('${lesson.id}', this.value)"
                                                   placeholder="Kaartnummer">
                                        </div>
                                        <div class="detail-row">
                                            <label>Beurt (1-10)</label>
                                            <input type="number" min="1" max="10" value="${lesson.beurtenUsed || ''}" 
                                                   onchange="updateBeurtenUsed('${lesson.id}', this.value)"
                                                   placeholder="Welke beurt">
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateClientOverview() {
            const clientOverview = document.getElementById('clientOverview');
            
            clients.clear();
            lessons.forEach(lesson => {
                if (!clients.has(lesson.clientName)) {
                    clients.set(lesson.clientName, {
                        name: lesson.clientName,
                        totalLessons: 0,
                        unpaidCount: 0,
                        beurtenkaarten: new Map()
                    });
                }
                
                const client = clients.get(lesson.clientName);
                client.totalLessons++;
                
                if (lesson.paymentStatus === 'unpaid') {
                    client.unpaidCount++;
                }
                
                if (lesson.paymentStatus === 'beurtenkaart' && lesson.beurtenkaartNumber) {
                    if (!client.beurtenkaarten.has(lesson.beurtenkaartNumber)) {
                        client.beurtenkaarten.set(lesson.beurtenkaartNumber, {
                            number: lesson.beurtenkaartNumber,
                            sessions: []
                        });
                    }
                    client.beurtenkaarten.get(lesson.beurtenkaartNumber).sessions.push(lesson);
                }
            });

            if (clients.size === 0) {
                clientOverview.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>Nog geen clients</p></div>';
                return;
            }

            clientOverview.innerHTML = Array.from(clients.values()).map(client => {
                // Get all beurtenkaarten for this client (from both lessons and stored cards)
                const clientCards = beurtenkaarten.filter(c => c.clientName === client.name);
                
                const beurtenkaartInfo = clientCards.map(card => {
                    const used = getBeurtenUsedForCard(client.name, card.cardNumber);
                    const remaining = 10 - used;
                    
                    return `<div class="beurtenkaart-info">
                        <strong>Kaart #${card.cardNumber}</strong>: ${used}/10 beurten gebruikt (${remaining} over)
                    </div>`;
                }).join('');

                return `
                    <div class="client-card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div class="client-name">${client.name}</div>
                            ${client.unpaidCount > 0 ? `
                                <button class="btn-icon" onclick="openBulkPayment('${escapeHtml(client.name)}')" 
                                        title="Bulk betaling voor ${client.unpaidCount} onbetaalde lessen"
                                        style="background: var(--clay-orange); font-size: 1rem;">
                                    üí≥
                                </button>
                            ` : ''}
                        </div>
                        <div class="client-stats">
                            <div class="stat">Totaal lessen: <strong>${client.totalLessons}</strong></div>
                            <div class="stat">Beurtenkaarten: <strong>${clientCards.length}</strong></div>
                            ${client.unpaidCount > 0 ? `<div class="stat" style="color: var(--clay-orange);">Onbetaald: <strong>${client.unpaidCount}</strong></div>` : ''}
                        </div>
                        ${beurtenkaartInfo}
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function setDefaultExportMonth() {
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const monthStr = lastMonth.toISOString().slice(0, 7);
            document.getElementById('exportMonth').value = monthStr;
        }

        function generateExport() {
            const monthInput = document.getElementById('exportMonth').value;
            if (!monthInput) {
                alert('Selecteer een maand');
                return;
            }

            const [year, month] = monthInput.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);

            const filteredLessons = lessons.filter(lesson => {
                const lessonDate = new Date(lesson.start);
                return lessonDate >= startDate && lessonDate <= endDate;
            });

            if (filteredLessons.length === 0) {
                document.getElementById('exportPreview').textContent = 'Geen lessen gevonden voor deze maand.';
                return;
            }

            let output = `FACTUUR EXPORT - ${monthInput}\n`;
            output += `${'='.repeat(80)}\n\n`;
            output += `Totaal Lessen: ${filteredLessons.length}\n`;
            output += `Periode: ${startDate.toLocaleDateString('nl-BE')} - ${endDate.toLocaleDateString('nl-BE')}\n\n`;
            output += `${'='.repeat(80)}\n\n`;

            filteredLessons.forEach((lesson, index) => {
                const date = new Date(lesson.start);
                output += `${index + 1}. ${date.toLocaleDateString('nl-BE')} ${date.toLocaleTimeString('nl-BE', {hour: '2-digit', minute: '2-digit'})}\n`;
                output += `   Client: ${lesson.clientName}\n`;
                output += `   Les: ${lesson.summary}\n`;
                output += `   Betaling: ${lesson.paymentStatus.toUpperCase()}`;
                
                if (lesson.paymentStatus === 'beurtenkaart') {
                    output += ` (Kaart #${lesson.beurtenkaartNumber || 'N/A'}, Beurt ${lesson.beurtenUsed || 'N/A'}/10)`;
                }
                output += `\n\n`;
            });

            output += `${'='.repeat(80)}\n`;
            output += `BETALINGS SAMENVATTING\n`;
            output += `${'='.repeat(80)}\n\n`;

            const paymentSummary = {};
            filteredLessons.forEach(lesson => {
                paymentSummary[lesson.paymentStatus] = (paymentSummary[lesson.paymentStatus] || 0) + 1;
            });

            Object.entries(paymentSummary).forEach(([type, count]) => {
                output += `${type.toUpperCase()}: ${count} les(sen)\n`;
            });

            document.getElementById('exportPreview').textContent = output;
        }

        function downloadCSV() {
            const monthInput = document.getElementById('exportMonth').value;
            if (!monthInput) {
                alert('Selecteer een maand');
                return;
            }

            const [year, month] = monthInput.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);

            const filteredLessons = lessons.filter(lesson => {
                const lessonDate = new Date(lesson.start);
                return lessonDate >= startDate && lessonDate <= endDate;
            });

            if (filteredLessons.length === 0) {
                alert('Geen lessen gevonden voor deze maand.');
                return;
            }

            let csv = 'Datum,Tijd,Client,Les,Betaalmethode,Beurtenkaart Nummer,Beurt Nummer\n';
            
            filteredLessons.forEach(lesson => {
                const date = new Date(lesson.start);
                const dateStr = date.toLocaleDateString('nl-BE');
                const timeStr = date.toLocaleTimeString('nl-BE', {hour: '2-digit', minute: '2-digit'});
                const beurtenkaartNum = lesson.beurtenkaartNumber || '';
                const beurtenUsed = lesson.beurtenUsed || '';
                
                csv += `"${dateStr}","${timeStr}","${lesson.clientName}","${lesson.summary}","${lesson.paymentStatus}","${beurtenkaartNum}","${beurtenUsed}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tennis-lessen-${monthInput}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function openBulkPayment(clientName) {
            const modal = document.getElementById('bulkPaymentModal');
            const clientNameEl = document.getElementById('bulkClientName');
            const unpaidLessons = lessons.filter(l => l.clientName === clientName && l.paymentStatus === 'unpaid');
            
            clientNameEl.textContent = clientName;
            document.getElementById('bulkLessonCount').textContent = unpaidLessons.length;
            
            // Store client name for later
            modal.dataset.clientName = clientName;
            
            // Reset form
            document.getElementById('bulkPaymentMethod').value = 'cash';
            document.getElementById('bulkBeurtenkaartSection').style.display = 'none';
            
            modal.classList.add('active');
        }

        function closeBulkPaymentModal() {
            document.getElementById('bulkPaymentModal').classList.remove('active');
        }

        function handleBulkPaymentMethodChange() {
            const method = document.getElementById('bulkPaymentMethod').value;
            const beurtenkaartSection = document.getElementById('bulkBeurtenkaartSection');
            
            if (method === 'beurtenkaart') {
                beurtenkaartSection.style.display = 'block';
            } else {
                beurtenkaartSection.style.display = 'none';
            }
        }

        async function applyBulkPayment() {
            const modal = document.getElementById('bulkPaymentModal');
            const clientName = modal.dataset.clientName;
            const paymentMethod = document.getElementById('bulkPaymentMethod').value;
            
            const unpaidLessons = lessons.filter(l => l.clientName === clientName && l.paymentStatus === 'unpaid');
            
            if (unpaidLessons.length === 0) {
                alert('Geen onbetaalde lessen gevonden');
                return;
            }

            if (paymentMethod === 'beurtenkaart') {
                const cardNumber = document.getElementById('bulkBeurtenkaartNumber').value.trim();
                if (!cardNumber) {
                    alert('Vul een beurtenkaart nummer in');
                    return;
                }
                
                // Sort by date to number chronologically
                unpaidLessons.sort((a, b) => new Date(a.start) - new Date(b.start));
                
                // Apply beurtenkaart payment with sequential numbering
                unpaidLessons.forEach((lesson, index) => {
                    lesson.paymentStatus = 'beurtenkaart';
                    lesson.beurtenkaartNumber = cardNumber;
                    lesson.beurtenUsed = index + 1; // Automatically number them 1, 2, 3, etc.
                });
            } else {
                // Apply regular payment method
                unpaidLessons.forEach(lesson => {
                    lesson.paymentStatus = paymentMethod;
                    lesson.beurtenkaartNumber = null;
                    lesson.beurtenUsed = 0;
                });
            }

            await saveToStorage();
            updateUI();
            closeBulkPaymentModal();
            
            // Show success message
            alert(`‚úÖ ${unpaidLessons.length} lessen bijgewerkt naar "${paymentMethod}" voor ${clientName}!`);
        }

        // Close modal on outside click
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                closeDeleteModal();
            }
        });

        document.getElementById('bulkPaymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'bulkPaymentModal') {
                closeBulkPaymentModal();
            }
        });

        // Initialize on load
        window.onload = async function() {
            await initStorage();
        };
    </script>
</body>
</html>
